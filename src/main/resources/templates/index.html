<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Township</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <link th:href="@{/css/index.css}" rel="stylesheet"/>
    <link th:href="@{/css/all.css}" rel="stylesheet"/>
    <script src="https://code.jquery.com/jquery-3.4.1.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js" integrity="sha256-qXBd/EfAdjOA2FGrGAG+b3YBn2tn5A6bhz+LSgYD96k=" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/mustache@latest"></script>
    <script th:src="@{/js/index.js}"></script>
</head>
<body>
<table id="supplies-table">
    <tbody>
    <tr id="supplies-row"></tr>
    </tbody>
</table>
<hr/>
<div id="town-container" class="d-flex flex-wrap">
</div>
<hr/>
<div id="builder-container" class="d-flex flex-wrap">
</div>
<hr/>
<div id="jobs-container" class="d-flex flex-wrap">
</div>
</body>
</html>

<script type="text/javascript" th:inline="javascript">
    const supplyPiles = [[${game.supplyPiles}]]
    const buildings = [[${buildings}]]
    const town = [[${game.town}]]

    $(() => {
        const $suppliesRow = $('#supplies-row')
        const $townContainer = $('#town-container')
        const $builderContainer = $('#builder-container')
        const numberFormatter = new Intl.NumberFormat()

        let supplyPileTemplate = '{{#supplies}}<td><div class="supply-header"><i class="supply-icon {{supply.iconClass}}"></i>{{supply.label}}</div><div class="progress"><div id="{{supply.label}}-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated bg-info" role="progressbar" aria-valuemin="0" aria-valuemax="{{pileSize}}"></div><span></span></div></td>{{/supplies}}'
        let townTemplate = '{{#buildings}}<span class="town-building" title="{{label}}"><i class="building-icon {{iconClass}}"></i></span>{{/buildings}}'
        let builderTemplate = '{{#buildings}}<span class="builder-building-container"><i class="builder-icon {{iconClass}}"></i><span>{{label}}</span><div class="builder-description">{{description}}</div><div class="builder-cost">Cost:{{#costs}} <span class="builder-cost">{{quantity}} <i class="{{iconClass}}"></i> {{supply}}</span>{{/costs}}</div><button class="btn btn-sm btn-secondary build-building-button" data-label="{{label}}">Build</button></span>{{/buildings}}'
        let iteration = 0

        Mustache.parse(supplyPileTemplate)
        Mustache.parse(townTemplate)
        Mustache.parse(builderTemplate)

        drawSupplies()
        drawTown()
        drawBuilder()
        tick()
        setInterval(tick, 1000)

        function tick() {
            incrementSupplies()
            draw()
            iteration++
            logIteration()
            saveGame()
        }

        function drawSupplies() {
            const supplies = {
                supplies: _.filter(supplyPiles, (v) => {
                    return v.unlocked
                }),
            }

            $suppliesRow.html(Mustache.render(supplyPileTemplate, supplies))

            _.each(supplyPiles, (pile) => {
                incrementSupplyPileQuantity(pile, 0)
            })
        }

        function draw() {
        }

        function drawTown() {
            $townContainer.html(Mustache.render(townTemplate, town))
        }

        function drawBuilder() {
            const builder = {
                buildings: _.filter(buildings, (v) => {
                    return v.unlocked
                }),
            }

            $builderContainer.html(Mustache.render(builderTemplate, builder))

            $('.build-building-button').click(function () {
                constructBuilding($(this).data('label'))
            })
        }

        function saveGame() {
            if (iteration % 10 === 0) {
                $.ajax({
                    url: '/save',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        guid: [[${game.guid}]],
                        town: town,
                        supplyPiles: supplyPiles,
                    }),
                    success: () => {
                        console.log('game saved')
                    },
                    error: () => {
                        console.log('error saving the game')
                    },
                })
            }
        }

        function logIteration() {
            if (iteration % 10 === 0) {
                console.log(`Iteration: ${iteration}`)
                console.table(supplyPiles)
            }
        }

        function incrementSupplies() {
            _.each(town.buildings, (b) => {
                if (b.produces) {
                    _.each(b.produces, (p) => {
                        const supplyPile = getCurrentPile(p.supply)
                        if (supplyPile) {
                            incrementSupplyPileQuantity(supplyPile, p.quantity)
                        }
                    })
                }
            })
        }

        function incrementSupplyPileQuantity(supplyPile, quantity) {
            supplyPile.quantity = _.clamp(supplyPile.quantity + quantity, 0, supplyPile.pileSize)
            updateSupplyPileProgressBar(supplyPile)
        }

        function updateSupplyPileProgressBar(supplyPile) {
            const $bar = $(`#${supplyPile.supply.label}-progress-bar`)
            const width = _.round((supplyPile.quantity / supplyPile.pileSize) * 100)

            $bar.css('width', `${width}%`).attr('aria-valuenow', width)
            $bar.next('span').html(`${numberFormatter.format(supplyPile.quantity)} / ${numberFormatter.format(supplyPile.pileSize)}`)

            if (width === 100) {
                $bar.removeClass('progress-bar-striped').removeClass('progress-bar-animated').removeClass('bg-info').removeClass('bg-danger').addClass('bg-success')
            } else if (width <= 10) {
                $bar.addClass('progress-bar-striped').addClass('progress-bar-animated').removeClass('bg-info').addClass('bg-danger').removeClass('bg-success')
            } else {
                $bar.addClass('progress-bar-striped').addClass('progress-bar-animated').addClass('bg-info').removeClass('bg-danger').removeClass('bg-success')
            }
        }

        function constructBuilding(buildingLabel) {
            const building = _.find(buildings, (b) => {
                return b.label === buildingLabel
            })

            const costs = []

            _.each(building.costs, (c) => {
                const quantity = getCurrentSupply(c.supply)

                costs.push({
                    label: c.supply,
                    current: quantity,
                    needed: c.quantity,
                })
            })

            for (let i = 0; i < costs.length; i++) {
                if (costs[i].current < costs[i].needed) return
            }

            _.each(costs, (c) => {
                incrementSupplyPileQuantity(getCurrentPile(c.label), -c.needed)
            })

            town.buildings.push(building)
            drawTown()
        }

        function getCurrentSupply(label) {
            return getCurrentPile(label).quantity
        }

        function getCurrentPile(label) {
            return _.find(supplyPiles, (pile) => {
                return pile.supply.label === label
            })
        }
    })
</script>